{% extends "base.html" %}
{% block title %}Breathing · MoodMate{% endblock %}

{% block content %}

<style>
  .mode-btn {
    padding: 0.5rem 1.25rem;
    border-radius: 9999px;
    background: var(--surface-alt);
    color: var(--text);
    transition: all 0.2s ease;
    white-space: nowrap;
  }
  .mode-btn.active {
    background: var(--primary);
    color: black;
    font-weight: 600;
  }
</style>

<div class="max-w-6xl mx-auto flex flex-col gap-14">

  <!-- PAGE INTRO -->
  <section class="text-center">
    <h1 class="text-4xl sm:text-5xl font-bold">
      Pause. Breathe. Reset.
    </h1>
    <p class="mt-4 text-lg text-[var(--muted)] max-w-2xl mx-auto">
      A short breathing exercise can help your body slow down.
      You’re always in control.
    </p>
  </section>

  <!-- BREATHING MODES -->
  <section class="flex justify-center gap-3 flex-wrap">
    <button class="mode-btn active" onclick="selectMode('478', this)">4-7-8 Calm</button>
    <button class="mode-btn" onclick="selectMode('box', this)">Box</button>
    <button class="mode-btn" onclick="selectMode('equal', this)">Equal</button>
    <button class="mode-btn" onclick="selectMode('gentle', this)">Gentle Reset</button>
  </section>

  <!-- TWO BOX LAYOUT -->
  <section class="grid grid-cols-1 md:grid-cols-2 gap-8">

    <!-- LEFT BOX -->
    <div class="rounded-3xl bg-[var(--surface)]
                border border-[var(--border)]
                p-10 flex flex-col items-center gap-6">

      <p id="breathText"
         class="uppercase tracking-[0.3em] text-sm
                text-[var(--primary)] font-semibold">
        Ready
      </p>

      <div id="breathingCircle"
           class="w-44 h-44 rounded-full
                  bg-gradient-to-br from-[var(--primary)] to-indigo-500
                  shadow-[0_0_60px_rgba(166,128,255,0.35)]
                  flex items-center justify-center
                  transition-transform duration-1000">
        <span class="material-symbols-outlined text-white text-6xl">
          spa
        </span>
      </div>

      <p class="text-sm text-[var(--muted)] text-center">
        Follow the rhythm shown above.
      </p>
    </div>

    <!-- RIGHT BOX -->
    <div class="rounded-3xl bg-[var(--surface)]
                border border-[var(--border)]
                p-10 flex flex-col justify-between gap-8">

      <div>
        <h3 class="text-xl font-semibold mb-2">
          Breathing session
        </h3>
        <p class="text-sm text-[var(--muted)]">
          Choose a pattern and press start.
          You can stop or reset anytime.
        </p>
      </div>

      <div class="flex gap-4">
        <button id="startBtn"
          onclick="startBreathing()"
          class="flex-1 px-6 py-3 rounded-xl
                 bg-[var(--primary)] text-black font-semibold">
          Start
        </button>

        <button id="stopBtn"
          onclick="stopBreathing()"
          disabled
          class="flex-1 px-6 py-3 rounded-xl
                 bg-[var(--surface-alt)]
                 border border-[var(--border)]
                 opacity-50 cursor-not-allowed">
          Stop
        </button>
      </div>

      <p class="text-xs text-[var(--muted)]">
        If your thoughts wander, gently return to the breath.
      </p>
    </div>

  </section>

  <!-- AFTER SESSION -->
  <section id="postPrompt"
    class="hidden rounded-3xl p-8 bg-[var(--surface-alt)]
           border border-[var(--border)] text-center">

    <h3 class="text-xl font-semibold mb-2">
      How do you feel now?
    </h3>

    <p class="text-sm text-[var(--muted)] mb-4">
      There’s no right or wrong answer.
    </p>

    <div class="flex justify-center gap-3 flex-wrap">
      <span class="px-4 py-2 rounded-full bg-[var(--primary)]/10 text-[var(--primary)] text-sm">Calmer</span>
      <span class="px-4 py-2 rounded-full bg-[var(--primary)]/10 text-[var(--primary)] text-sm">About the same</span>
      <span class="px-4 py-2 rounded-full bg-[var(--primary)]/10 text-[var(--primary)] text-sm">Still tense</span>
    </div>

    <a href="{% url 'journal_create' %}"
       class="inline-block mt-6 text-sm font-medium text-[var(--primary)] hover:underline">
      Write a few thoughts →
    </a>
  </section>

  <!-- PROFESSIONAL SUPPORT (NEPAL) -->
  <section
    class="rounded-3xl border border-[var(--border)]
           bg-[var(--surface-alt)] p-8
           flex flex-col md:flex-row
           items-center justify-between gap-8">

    <div class="max-w-xl">
      <h3 class="text-xl font-semibold mb-2">
        Professional support in Nepal
      </h3>
      <p class="text-sm text-[var(--muted)] leading-relaxed">
        If you’re feeling overwhelmed or need to talk to someone,
        trusted mental health support is available within Nepal.
        You’re not alone in this.
      </p>
    </div>

    <div class="flex flex-wrap gap-3 justify-center md:justify-end">

      <!-- Emergency -->
      <a href="tel:100"
         class="flex items-center gap-2 px-6 py-3 rounded-xl
                bg-red-500/10 text-red-600
                hover:bg-red-500 hover:text-white
                transition-all font-semibold text-sm">
        <span class="material-symbols-outlined">call</span>
        Emergency (100)
      </a>

      <!-- TPO Nepal -->
      <a href="https://tponepal.org" target="_blank"
         class="flex items-center gap-2 px-6 py-3 rounded-xl
                bg-[var(--surface)] border border-[var(--border)]
                hover:border-[var(--primary)] transition-all
                font-semibold text-sm">
        <span class="material-symbols-outlined">psychology</span>
        TPO Nepal
      </a>

      <!-- KOSHISH Nepal -->
      <a href="https://koshishnepal.org" target="_blank"
         class="flex items-center gap-2 px-6 py-3 rounded-xl
                bg-[var(--surface)] border border-[var(--border)]
                hover:border-[var(--primary)] transition-all
                font-semibold text-sm">
        <span class="material-symbols-outlined">diversity_3</span>
        KOSHISH Nepal
      </a>

    </div>
  </section>

</div>

<script>
  let currentMode = "478";
  let running = false;
  let timeoutRef = null;

  const modes = {
    "478": [
      { text: "Inhale", scale: 1.3, duration: 4000 },
      { text: "Hold", scale: 1.3, duration: 7000 },
      { text: "Exhale", scale: 1.0, duration: 8000 },
    ],
    "box": [
      { text: "Inhale", scale: 1.3, duration: 4000 },
      { text: "Hold", scale: 1.3, duration: 4000 },
      { text: "Exhale", scale: 1.0, duration: 4000 },
      { text: "Hold", scale: 1.0, duration: 4000 },
    ],
    "equal": [
      { text: "Inhale", scale: 1.3, duration: 5000 },
      { text: "Exhale", scale: 1.0, duration: 5000 },
    ],
    "gentle": [
      { text: "Inhale gently", scale: 1.2, duration: 6000 },
      { text: "Exhale gently", scale: 1.0, duration: 6000 },
    ],
  };

  function selectMode(mode, btn) {
    if (running) return;
    currentMode = mode;
    document.querySelectorAll(".mode-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  }

  function startBreathing() {
    if (running) return;
    running = true;

    document.getElementById("postPrompt").classList.add("hidden");

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    startBtn.disabled = true;
    startBtn.classList.add("opacity-50", "cursor-not-allowed");
    stopBtn.disabled = false;
    stopBtn.classList.remove("opacity-50", "cursor-not-allowed");

    const circle = document.getElementById("breathingCircle");
    const text = document.getElementById("breathText");

    let steps = modes[currentMode];
    let index = 0;

    function runStep() {
      if (!running) return;
      const step = steps[index];
      text.innerText = step.text;
      circle.style.transform = `scale(${step.scale})`;

      timeoutRef = setTimeout(() => {
        index = (index + 1) % steps.length;
        runStep();
      }, step.duration);
    }

    runStep();
  }

  function stopBreathing() {
    running = false;
    clearTimeout(timeoutRef);

    document.getElementById("breathingCircle").style.transform = "scale(1)";
    document.getElementById("breathText").innerText = "Session ended";

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    startBtn.disabled = false;
    startBtn.classList.remove("opacity-50", "cursor-not-allowed");
    stopBtn.disabled = true;
    stopBtn.classList.add("opacity-50", "cursor-not-allowed");

    document.getElementById("postPrompt").classList.remove("hidden");
  }
</script>

{% endblock %}
